#include "player.h"
#include "config.h"
#include "pixmaps.h"
#include "wavs.h"

static void player_draw(Player *self);
static void player_clear(Player *self);

void player_init(Player *self) {
    self->state = playerStopped;
    self->col = PLAYER_MIN_COL;
    self->row = PLAYER_ROW;
    self->sprite = (Sprite){PLAYER_WIDTH, PLAYER_HEIGHT, playerPixMap};
    self->explosionSpriteSet = 0;
    self->explosionSprite[0] =
        (Sprite){PLAYER_WIDTH, PLAYER_HEIGHT, playerExplosionPixMap_0};
    self->explosionSprite[1] =
        (Sprite){PLAYER_WIDTH, PLAYER_HEIGHT, playerExplosionPixMap_1};
    self->explosionSound = (Sound){PLAYER_EXPLOSION};
    
    lives_init(&self->lives);
    score_init(&self->score);
}

static void player_draw(Player *self) {
    sprite_draw(&self->sprite, &self->col, &self->row);
}

static void player_clear(Player *self) {
    sprite_clear(&self->sprite, &self->col, &self->row);
}

void player_launch(Player *self) {
    player_draw(self);
}

void player_update(Player *self) {
    player_clear(self);
    
    switch (self->state) {
    case playerStopped:
        break;
    case playerMovingLeft:
        self->col -= PLAYER_ADVANCE_COL;
        if (self->col <= PLAYER_MIN_COL)
            self->col = PLAYER_MIN_COL;
        break;
    case playerMovingRight:
        self->col += PLAYER_ADVANCE_COL;
        if (self->col >= PLAYER_MAX_COL)
            self->col = PLAYER_MAX_COL;
        break;
    case playerExploding:
        self->sprite = self->explosionSprite[self->explosionSpriteSet % 2];
        self->explosionSpriteSet++;
        
        if (self->countDown > 0) {
            self->countDown--;
        } else {
            if (self->lives.value > 0) {
                // respawn
                self->state = playerStopped;
                self->col = PLAYER_MIN_COL;
                self->sprite = (Sprite){PLAYER_WIDTH, PLAYER_HEIGHT, playerPixMap};
            } else {
                self->state = playerDead;
            }
        }
        break;
    case playerDead:
        // game over
        break;
    }

    player_draw(self);
}

void player_left(Player *self) {
    if (self->state != playerExploding && self->state != playerDead)
        self->state = playerMovingLeft;
}

void player_right(Player *self) {
    if (self->state != playerExploding && self->state != playerDead)
        self->state = playerMovingRight;
}

void player_stop(Player *self) {
    if (self->state != playerExploding && self->state != playerDead)
        self->state = playerStopped;
}

void player_hit(Player *self) {
    if (self->state != playerExploding && self->state != playerDead) {
        self->state = playerExploding;
        self->countDown = PLAYER_EXPLODING_TIME / PLAYER_UPDATE_PERIOD;
        self->explosionSpriteSet = 0;
        
        sound_play(&self->explosionSound);

        if (self->lives.value > 0) {
            self->lives.value--;
            player_lives_draw(self);
        }
    }
}

void player_invaded(Player *self) {
    self->state = playerDead;
    self->lives.value = 0;
    player_lives_draw(self);
}

void player_lives_draw(Player *self) {
    lives_update(&self->lives);
}

void player_score_draw(Player *self) {
    score_update(&self, &self->score);
}