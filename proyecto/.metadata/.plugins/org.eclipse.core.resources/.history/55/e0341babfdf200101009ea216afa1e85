#include "player.h"
#include "config.h"
#include "pixmaps.h"
#include "wavs.h"

static void player_draw(Player *self);
static void player_clear(Player *self);

void player_init(Player *self) {
  self->state = playerStopped;
  self->col = PLAYER_MIN_COL;
  self->row = PLAYER_ROW;
  self->sprite = (Sprite){PLAYER_WIDTH, PLAYER_HEIGHT, playerPixMap};
  self->explosionSpriteSet = 0;
  self->explosionSprite[0] =
      (Sprite){PLAYER_WIDTH, PLAYER_HEIGHT, playerExplosionPixMap_0};
  self->explosionSprite[1] =
      (Sprite){PLAYER_WIDTH, PLAYER_HEIGHT, playerExplosionPixMap_1};
  self->explosionSound = (Sound){PLAYER_EXPLOSION};
  lives_init(&self->lives);
  score_init(&self->score);
  player_draw(self);
}

static void player_draw(Player *self) {
    if( self->state == playerExploding )
    {
        sprite_draw(&self->explosionSprite[self->explosionSpriteSet % 2], self->col, self->row);
    }
    else if ( self->state != playerDead )
    {
        sprite_draw(&self->sprite, self->col, self->row);
    }
}

static void player_clear(Player *self) {
    if( self->state == playerExploding )
    {
        sprite_clear(&self->explosionSprite[self->explosionSpriteSet % 2], self->col, self->row);
    }
    else if ( self->state != playerDead )
    {
        sprite_clear(&self->sprite, self->col, self->row);
    }
}

void player_launch(Player *self) {
    player_draw(self);
}

void player_update(Player *self) {
  switch (self->state) {
  case playerStopped:
    break;
  case playerMovingLeft:
    player_clear(self);
    self->col -= PLAYER_ADVANCE_COL;
    if (self->col < PLAYER_MIN_COL)
      self->col = PLAYER_MIN_COL;
    player_draw(self);
    break;
  case playerMovingRight:
    player_clear(self);
    self->col += PLAYER_ADVANCE_COL;
    if (self->col > PLAYER_MAX_COL)
      self->col = PLAYER_MAX_COL;
    player_draw(self);
    break;
  case playerExploding:
    player_clear(self);
    self->explosionSpriteSet++;
    self->countDown--;
    if (self->countDown == 0)
    {
        lives_update(&self->lives);
        if (self->lives.value == 0)
        {
            self->state = playerDead;
        }
        else
        {
            self->state = playerStopped;
            self->col = PLAYER_MIN_COL; // Respawn
            player_draw(self);
        }
    }
    else
    {
        player_draw(self);
    }
    break;
  case playerDead:
    break;
  }
}

void player_left(Player *self) {
    if (self->state != playerExploding && self->state != playerDead)
        self->state = playerMovingLeft;
}

void player_right(Player *self) {
    if (self->state != playerExploding && self->state != playerDead)
        self->state = playerMovingRight;
}

void player_stop(Player *self) {
    if (self->state != playerExploding && self->state != playerDead)
        self->state = playerStopped;
}

void player_hit(Player *self) {
    player_clear(self);
    self->state = playerExploding;
    self->countDown = PLAYER_EXPLODING_TIME / PLAYER_UPDATE_PERIOD;
    self->explosionSpriteSet = 0;
    sound_play(&self->explosionSound);
    player_draw(self);
}

void player_invaded(Player *self) {
    self->state = playerDead;
    self->lives.value = 0;
    lives_update(&self->lives);
}
